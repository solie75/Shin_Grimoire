- VM 사용 이유

자체 서버 는 유저가 늘어날 때 대처가 힘들고, 관리비용이 비싸며, 정전과 같은 외부 사고에 취약하다. AWS 같은 클라우드 업체의 virtual machine 을 빌려서 쓰면 필요한 만큼만 사용하면 된다.
AWS 에서는 EC2(Elastic Cloud Compute) 가상머신을 사용하고 GameLift 는 이를 묶어서 Fleet 으로 관리한다.

클라우드는 하이퍼 바이저로 하나의 거대한 슈퍼컴퓨터(물리 서버) 를 여러 개의 작은 가상 컴퓨터 (vm) 으로 나누어주는 기술을 사용한다.

- VM 관련 용어

Region : 물리적인 데이터 센터가 있는 국가나 도시
Availability Zone (가용 영역) : 하나의 리전 안에서도 서로 떨어진 데이터 센터 건물들. (이중화)
VPC (Virtaul Pricate Cloud) : 클라우드 안에 마련된 격리 네트워크 공간
Managed Fleet : 직접 서버를 켜는 것이 아니라 GameLift 가 EC2를 알아서 켜고 끄고 관리해주는 방식.
##### EC2 Instance Server Build

- Create Batch File

EC2 인스턴스에서 서버 빌드를 실행하려면, 언리얼 엔진 데디케이티드 서버 빌드 실행에 필요한 필수 구성 요소를 설치하는 방법을 EC2 인스턴스에 알려주는 배치 파일을 만들어야 한다.

배치 파일은 install.bat 으로 이름짓고 해당 install script 는 게임 빌드가 Amazon GameLift Fleet 이 배포될 때마다 실행된다.
[ref](https://docs.aws.amazon.com/gameliftservers/latest/developerguide/gamelift-build-cli-uploading-install.html)

Build_1\WindowsServer\Engine\Extras\Redist\en-us 폴더의 UEPrereqSetup_x64 파일이 바로 install.bat 에 필요한 언리얼 엔진 필수 구성 요소 설치 실행 파일이다.

 Build_1\WindowsServer 폴더에 install.bat 생성.
```txt
// install.bat
Engine\Extras\Redist\en-us\UEPrereqSetup_x64.exe /install /quiet /norestart /log c:\game\vcredist_2013_x64.log
```
1. /install : 패키지 설치한다.
2. /quiet : 설치 프로그램을 자동모드(silent mode) 로 실행하여 설치 과정 중에 사용자 인터페이스가 표시되지 않게 한다.
3. /norestart : 플래그는 설치 완료 후 컴퓨터가 재부팅 되는 것을 막아준다.
4. /log : 플래그 뒤에 경로를 적으면 설치 세부 정보가 기록될 로그의 위치와 이름을 지정한다.

WindowServer 는 다시 패키징 하면 언리얼 엔진 측에서 폴더 자체를 싹 지우고 새로 만들거나 덮어씌울 수 있는 폴더이다. 그때 install.bat 도 함께 날아가 버릴 수 있다. 때문에 프로젝트 폴더에 'InstallBat' 폴더 생성하고 install.bat 을 복사 붙여넣기 한다. 나중에 새 빌드 할 때에 이 복사해 놓은 것을 가져다가 쓰기만 하면 된다.

##### [Upload Build](https://docs.aws.amazon.com/cli/latest/reference/gamelift/upload-build.html)

다음 명령어를 입력한다.
```cmd
aws gamelift upload-build ^
--name FPSTemplateServerBuild ^
--operating-system WINDOWS_2016 ^
--server-sdk-version "5.1.3" ^
--build-root "C:\Unreal_Project\FPSTemplate_5_4_or_5_5\Build\Build_1\WindowsServer" ^
--build-version 1.0.0 ^
--region ap-northeast-2 ^
--profile shin
```

operating-system 으로 운영체제를 지정한다. (WINDOWS_2016 은 GameLift 가 지원하는 운영체제 버젼이다.)
build-version 으로 버전 을 지을 수 있다. 처음 올리는 빌드이니 1.0.0 으로 이름짓는다.


그러면 다음과 같이 빌드가 업로드 되고 빌드 id 가 생긴다
```cmd
Uploading C:\Unreal_Project\FPSTemplate_5_4_or_5_5\Build\Build_1\WindowsServer:  869.7 MiB / 869.7 MiB  (100.00%)Successfully uploaded C:\Unreal_Project\FPSTemplate_5_4_or_5_5\Build\Build_1\WindowsServer to AWS GameLift
Build ID: build-be893ee4-38dd-44f2-bf73-afba0fcfa279
```

##### Create Fleet

- AWS Console $\to$ Managed EC2 $\to$ Fleets $\to$ 'Create Managed EC2 fleet' 클릭 $\to$  'Define Managed EC2 fleet details'에서 
	1. Name 을 설정
	2. BinaryType을 Build 로 지정
	3. Build 에서 이전에 업로드한 FPSTemplateServerBuild 선택
	4. 'Next' 클릭
- 'Define instance details'에서
	1. Locations 에 ap-northeast-2 를 선택하여 인스턴스를 배포할 location 을 선택.
	2. Fleet type 에 'On-Demand' 지정. (Spot 인스턴스는 설명대로 현재 사용되지 않는 AWS 컴퓨팅 용량을 활용하는데, 가용성은 변동될 수 있으며 AWS 가 사용을 중단시킬 수도 있다., On-Demand 는 중단을 겪지 않도록 매우 중료한 작업을 진행할 때 선택한다. Spot Instance 가 On-Demand Instance 보다 저렴하다.)
		1. Instance types 에서 가상 머신에 할당될 하드웨어를 지정한다.![EC2Fleet 생성 중 Instance Type 지정](/Image/Server/AWS_EC2FleetCreating_InstanceType.png)
			- Pricing History 를 클릭하여 위치별 가격 변동을 타임라인으로 볼 수 있다.
			- 드롭다운을 열어보면 'c5.large' 옆에 Free tier eligible (프리 티어 사용 가능) 라고 적힌 게 있다. 이와 같이 프리티어가 제공되는 인스턴스 유형 옆에는 항상 이 문구가 표시된다.![EC2 Instance Type 의 Pricing History](/Image/Server/AWS_EC2FleetCreating_InstanceType_PricingHistory.png)
			- 현재는 해당 문구가 있는 타입을 선택해야 하며 실제 게임을 출시할 계획이라면 수익 모델을 잘 짜서 데디케이티드 서버 호스팅 비용을 감당할 수 있도록 해야 한다.
			- 'c5.large' 를 선택한다. 또한 여기에서 중요한 것은 Fleet type 에 반드시 On-Demand 를 지정해야 c5.large 무료 시간을받을 수 있다. 
			- Next 클릭
- 'Configure runtime' 에서
	- 기본적으로 우리의 빌드 파일은 EC2 인스턴스 내의 Game 폴더에 위치하게 된다. 해당 Game 폴더에 데디케이티드 서버 실행 파일의 경로를 입력해 준다. 이때의 경로는 C:\Unreal_Project\FPSTemplate_5_4_or_5_5\Build\Build_1\WindowsServer\FPSTemplate\Binaries\Win64\FPSTemplateServer.exe 중에서 FPSTemplate\Binaries\Win64\FPSTemplateServer.exe 만을 입력해준다.
	- EC2 인스턴스 안에는 GameLift Agent 라는 관리자가 이미 존재하기 때문에 서버가 켜지면 이 Agent 와 내부 통신을 하기 때문에, 별고의 신분증(토큰, 호스트ID 등)을 파라미터로 넘겨줄 필요가 없이 자동으로 인증된다. GameLift 가 서버를 킬 때 언리얼 엔진 기본값이 7777 이라 안 적어도 될 수 있지만 명시적으로 적어주는 것이 안전하기 때문과 나중에 한 컴퓨터(EC2)에 서버를 2개 이상 띄울 셩우(멀티 프로세스), 하나는 7777, 다른 하나는 7778로 지정해야 하는데, 이때 이 파라미터가 필수적으로 사용된다.  -log 는 서버가 로그를 출력하도록 강제한다. 비록 화면은 없지만, GameLift 서비스가 이 쏟아져 나오는 로그를 가로채서 파일로 저장해 둔다. 나중에 콘솔에서 로그 다운로드 기능을 통해 서버가 왜 죽었는지 확인할 수 있게 해준다. 즉 Launch parameters 에는 '-port=7777 -log' 를 입력한다.
	- ![[AWS_EC2Fleet_ConfigureRuntime.png]]
- EC2 port settings 에서
	- Type 을 Custom UDP 로 설정. (언리얼 엔진 빌드의 경우 'Custom UDP'를 선택해야 한다. TCP 와 달리 UDP 는 패킷 전송 시마다 확인 신호를 보낼 필요가 없어 일반적으로 더 빠르다. 그래서 언리얼 엔진 서버용으로 이걸 선택한다.)
	- Port range 를 7777로 설정. (사용되는 모든 포트를 지정한다.)
	- IP address range 를 0.0.0.0/0 으로 설정. (해당 설정은 수신할 IP 주소 범위를 지정하는 것으로 모든 IP 주소의 접속을 허용하기 위해서 0.0.0.0/0 을 설정한다.)
- 'Next' 클릭

생성하면 처음은 Downloading 상태로 Active 상태가 되기 가지 30 분 정도가 소요된다. 해당 EC2 인스턴스가 활성항태라면 시간이 차감 되기 때문에 사용하지 않을 때에는 반드시 해당 Fleet 를 삭제해야 한다.

##### Connecting to the server build

- CLI 로 EC2 GameLift Fleet 에 GameSession 생성.
	- fleet id 는 EC2 의 Fleet id 를 사용하고 location 은 자동으로 region 과 같게 적용된다.
```cmd
aws gamelift create-game-session ^
--fleet-id fleet-32f9f1d6-7871-4f3e-aafd-e0d33343b39c ^
--name GameLiftHostedSession ^
--maximum-player-session-count 2 ^
--region ap-northeast-2 ^
--profile shin
```
- 다음과 같이 GameSession 이 생성된다.
```cmd
{
    "GameSession": {
        "GameSessionId": "arn:aws:gamelift:ap-northeast-2::gamesession/fleet-32f9f1d6-7871-4f3e-aafd-e0d33343b39c/gsess-9cb81ac9-2514-434d-b09c-2cccb39965cb",
        "Name": "GameLiftHostedSession",
        "FleetId": "fleet-32f9f1d6-7871-4f3e-aafd-e0d33343b39c",
        "FleetArn": "arn:aws:gamelift:ap-northeast-2:634747716040:fleet/fleet-32f9f1d6-7871-4f3e-aafd-e0d33343b39c",
        "CreationTime": "2025-12-20T02:36:54.767000+09:00",
        "CurrentPlayerSessionCount": 0,
        "MaximumPlayerSessionCount": 2,
        "Status": "ACTIVATING",
        "GameProperties": [],
        "IpAddress": "54.180.142.119",
        "DnsName": "ec2-54-180-142-119.ap-northeast-2.compute.amazonaws.com",
        "Port": 7777,
        "PlayerSessionCreationPolicy": "ACCEPT_ALL",
        "Location": "ap-northeast-2"
    }
}
```

게임 세션 id 가 있고 세션에 IP 주소가 있으며 7777 번 포트가 열려 있다. 즉, 플레이어 세션을 생성하든 안 하든 상관없이 해당 서버에 접속할 수 있어야 한다는 뜻이다.

클라이언트 실행파일 두 개를 열고 각각에 open 54.180.142.119:7777 을 입력하면 캐릭터가 서로 상호작용 할 수 있다.

이때 GameLift 콘솔로 돌아와서 EC2 Fleet 의 Metrix 를 보면 Active Instance 가 여전히 1개로 꾸준히 유지되는 것을 볼 수 있다. 

서버에 클라이언트 접속을 확인했다면 EC2 Fleet 을 확실하게 Delete 한다.

